version: "3.9"

services:
  # ==========================================
  # MariaDB Databases (5 separate containers)
  # ==========================================
  
  adminCon:
    image: mariadb:10.11.4
    container_name: adminCon
    environment:
      - MARIADB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MARIADB_DATABASE=adminDB
      - MARIADB_USER=${DB_USER}
      - MARIADB_PASSWORD=${DB_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - adminVol:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$${MARIADB_USER} -p$${MARIADB_PASSWORD} --silent"]
      interval: 5s
      timeout: 3s
      retries: 40
    restart: unless-stopped

  blogCon:
    image: mariadb:10.11.4
    container_name: blogCon
    environment:
      - MARIADB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MARIADB_DATABASE=blogDB
      - MARIADB_USER=${DB_USER}
      - MARIADB_PASSWORD=${DB_PASSWORD}
    ports:
      - "3307:3306"
    volumes:
      - blogVol:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$${MARIADB_USER} -p$${MARIADB_PASSWORD} --silent"]
      interval: 5s
      timeout: 3s
      retries: 40
    restart: unless-stopped

  emailCon:
    image: mariadb:10.11.4
    container_name: emailCon
    environment:
      - MARIADB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MARIADB_DATABASE=emailDB
      - MARIADB_USER=${DB_USER}
      - MARIADB_PASSWORD=${DB_PASSWORD}
    ports:
      - "3308:3306"
    volumes:
      - emailVol:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$${MARIADB_USER} -p$${MARIADB_PASSWORD} --silent"]
      interval: 5s
      timeout: 3s
      retries: 40
    restart: unless-stopped

  imagesCon:
    image: mariadb:10.11.4
    container_name: imagesCon
    environment:
      - MARIADB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MARIADB_DATABASE=imagesDB
      - MARIADB_USER=${DB_USER}
      - MARIADB_PASSWORD=${DB_PASSWORD}
    ports:
      - "3309:3306"
    volumes:
      - imagesVol:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$${MARIADB_USER} -p$${MARIADB_PASSWORD} --silent"]
      interval: 5s
      timeout: 3s
      retries: 40
    restart: unless-stopped

  shopCon:
    image: mariadb:10.11.4
    container_name: shopCon
    environment:
      - MARIADB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MARIADB_DATABASE=shopDB
      - MARIADB_USER=${DB_USER}
      - MARIADB_PASSWORD=${DB_PASSWORD}
    ports:
      - "3310:3306"
    volumes:
      - shopVol:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$${MARIADB_USER} -p$${MARIADB_PASSWORD} --silent"]
      interval: 5s
      timeout: 3s
      retries: 40
    restart: unless-stopped

  # ==========================================
  # Email Service (Port 8083)
  # ==========================================
  
  email-service:
    build: ./email-service
    container_name: email-service
    depends_on:
      emailCon:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mariadb://emailCon:3306/emailDB
      - SPRING_DATASOURCE_USERNAME=${DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info
      - MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED=true
      - MANAGEMENT_HEALTH_LIVENESSSTATE_ENABLED=true
      - MANAGEMENT_HEALTH_READINESSSTATE_ENABLED=true
      - MAIL_HOST=${MAIL_HOST}
      - MAIL_PORT=${MAIL_PORT}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_PROTOCOL=${MAIL_PROTOCOL:-smtp}
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "8083:8083"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8083/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 5s
      timeout: 3s
      retries: 40
    restart: unless-stopped

  # ==========================================
  # Image Service (Port 8084)
  # ==========================================
  
  image-service:
    build: ./image-service
    container_name: image-service
    depends_on:
      imagesCon:
        condition: service_healthy
      email-service:
        condition: service_started
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mariadb://imagesCon:3306/imagesDB
      - SPRING_DATASOURCE_USERNAME=${DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info
      - MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED=true
      - MANAGEMENT_HEALTH_LIVENESSSTATE_ENABLED=true
      - MANAGEMENT_HEALTH_READINESSSTATE_ENABLED=true
      - EMAIL_BASE_URL=http://email-service:8083
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "8084:8084"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8084/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 5s
      timeout: 3s
      retries: 40
    restart: unless-stopped

  # ==========================================
  # Admin Service (Port 8081)
  # ==========================================
  
  admin-service:
    build: ./admin-service
    container_name: admin-service
    depends_on:
      adminCon:
        condition: service_healthy
      email-service:
        condition: service_started
      image-service:
        condition: service_started
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mariadb://adminCon:3306/adminDB
      - SPRING_DATASOURCE_USERNAME=${DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info
      - MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED=true
      - MANAGEMENT_HEALTH_LIVENESSSTATE_ENABLED=true
      - MANAGEMENT_HEALTH_READINESSSTATE_ENABLED=true
      - EMAIL_BASE_URL=http://email-service:8083
      - IMAGE_BASE_URL=http://image-service:8084
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "8081:8081"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8081/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 5s
      timeout: 3s
      retries: 40
    restart: unless-stopped

  # ==========================================
  # Blog Service (Port 8082)
  # ==========================================
  
  blog-service:
    build: ./blog-service
    container_name: blog-service
    depends_on:
      blogCon:
        condition: service_healthy
      email-service:
        condition: service_started
      image-service:
        condition: service_started
      admin-service:
        condition: service_started
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mariadb://blogCon:3306/blogDB
      - SPRING_DATASOURCE_USERNAME=${DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info
      - MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED=true
      - MANAGEMENT_HEALTH_LIVENESSSTATE_ENABLED=true
      - MANAGEMENT_HEALTH_READINESSSTATE_ENABLED=true
      - EMAIL_BASE_URL=http://email-service:8083
      - IMAGE_BASE_URL=http://image-service:8084
      - ADMIN_BASE_URL=http://admin-service:8081
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "8082:8082"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8082/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 5s
      timeout: 3s
      retries: 40
    restart: unless-stopped

  # ==========================================
  # Shop Service (Port 8085)
  # ==========================================
  
  shop-service:
    build: ./shop-service
    container_name: shop-service
    depends_on:
      shopCon:
        condition: service_healthy
      email-service:
        condition: service_started
      image-service:
        condition: service_started
      admin-service:
        condition: service_started
      blog-service:
        condition: service_started
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mariadb://shopCon:3306/shopDB
      - SPRING_DATASOURCE_USERNAME=${DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info
      - MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED=true
      - MANAGEMENT_HEALTH_LIVENESSSTATE_ENABLED=true
      - MANAGEMENT_HEALTH_READINESSSTATE_ENABLED=true
      - EMAIL_BASE_URL=http://email-service:8083
      - IMAGE_BASE_URL=http://image-service:8084
      - ADMIN_BASE_URL=http://admin-service:8081
      - BLOG_BASE_URL=http://blog-service:8082
      - PAYPAL_CLIENT_ID=${PAYPAL_CLIENT_ID}
      - PAYPAL_CLIENT_SECRET=${PAYPAL_CLIENT_SECRET}
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "8085:8085"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8085/actuator/health | grep -q '\"status\":\"UP\"'"]
      interval: 5s
      timeout: 3s
      retries: 40
    restart: unless-stopped

# ==========================================
# Volumes (5 separate volumes)
# ==========================================

volumes:
  adminVol:
    driver: local
  blogVol:
    driver: local
  emailVol:
    driver: local
  imagesVol:
    driver: local
  shopVol:
    driver: local
