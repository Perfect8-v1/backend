version: "3.9"

services:
  mysql:
    image: mariadb:10.11
    container_name: mysql
    environment:
      - MARIADB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MARIADB_DATABASE=${DB_NAME:-perfect8_shop}
      - MARIADB_USER=${DB_USER}
      - MARIADB_PASSWORD=${DB_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
    restart: unless-stopped

  email-service:
    build: ./email-service
    container_name: email-service
    depends_on:
      - mysql
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${DB_NAME:-perfect8_shop}
      - SPRING_DATASOURCE_USERNAME=${DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info
      - MAIL_HOST=${MAIL_HOST}
      - MAIL_PORT=${MAIL_PORT}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_PROTOCOL=${MAIL_PROTOCOL:-smtp}
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "8083:8083"
    restart: unless-stopped

  image-service:
    build: ./image-service
    container_name: image-service
    depends_on:
      - mysql
      - email-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${DB_NAME:-perfect8_shop}
      - SPRING_DATASOURCE_USERNAME=${DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info
      - EMAIL_BASE_URL=http://email-service:8083
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "8084:8084"
    restart: unless-stopped

  admin-service:
    build: ./admin-service
    container_name: admin-service
    depends_on:
      - mysql
      - email-service
      - image-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${DB_NAME:-perfect8_shop}
      - SPRING_DATASOURCE_USERNAME=${DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info
      - EMAIL_BASE_URL=http://email-service:8083
      - IMAGE_BASE_URL=http://image-service:8084
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "8081:8081"
    restart: unless-stopped

  blog-service:
    build: ./blog-service
    container_name: blog-service
    depends_on:
      - mysql
      - email-service
      - image-service
      - admin-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${DB_NAME:-perfect8_shop}
      - SPRING_DATASOURCE_USERNAME=${DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info
      - EMAIL_BASE_URL=http://email-service:8083
      - IMAGE_BASE_URL=http://image-service:8084
      - ADMIN_BASE_URL=http://admin-service:8081
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "8082:8082"
    restart: unless-stopped

  shop-service:
    build: ./shop-service
    container_name: shop-service
    depends_on:
      - mysql
      - email-service
      - image-service
      - admin-service
      - blog-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${DB_NAME:-perfect8_shop}
      - SPRING_DATASOURCE_USERNAME=${DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info
      - EMAIL_BASE_URL=http://email-service:8083
      - IMAGE_BASE_URL=http://image-service:8084
      - ADMIN_BASE_URL=http://admin-service:8081
      - BLOG_BASE_URL=http://blog-service:8082
      - PAYPAL_CLIENT_ID=${PAYPAL_CLIENT_ID}
      - PAYPAL_CLIENT_SECRET=${PAYPAL_CLIENT_SECRET}
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "8085:8085"
    restart: unless-stopped

volumes:
  db_data:
    driver: local
